<!-- (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô <script>) -->

<script>
  let sharedVerified = false;

  function base32ToBytes(base32) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    const clean = base32.replace(/=+$/, '').toUpperCase().replace(/[^A-Z2-7]/g, '');
    const bytes = [];
    let bits = 0, value = 0;
    for (let i = 0; i < clean.length; i++) {
      value = (value << 5) | alphabet.indexOf(clean[i]);
      bits += 5;
      if (bits >= 8) {
        bytes.push((value >> (bits - 8)) & 0xff);
        bits -= 8;
      }
    }
    return new Uint8Array(bytes);
  }

  async function generateGarenaOTP(secretBase32, counter) {
    const key = base32ToBytes(secretBase32);
    const buffer = new ArrayBuffer(8);
    const view = new DataView(buffer);
    view.setUint32(4, counter);

    const keyCrypto = await crypto.subtle.importKey("raw", key, { name: "HMAC", hash: "SHA-1" }, false, ["sign"]);
    const hmac = await crypto.subtle.sign("HMAC", keyCrypto, buffer);
    const hmacBytes = new Uint8Array(hmac);

    const offset = hmacBytes[hmacBytes.length - 1] & 0xf;
    const code = ((hmacBytes[offset] & 0x7f) << 24) |
                ((hmacBytes[offset + 1] & 0xff) << 16) |
                ((hmacBytes[offset + 2] & 0xff) << 8) |
                (hmacBytes[offset + 3] & 0xff);

    return (code % 1000000).toString().padStart(6, '0');
  }

  function loadAccounts() {
    return JSON.parse(localStorage.getItem("garenaAccounts") || "[]");
  }

  function saveAccounts(accounts) {
    localStorage.setItem("garenaAccounts", JSON.stringify(accounts));
  }

  function formatThaiDate(isoString) {
    return new Date(isoString).toLocaleString("th-TH", { dateStyle: "medium", timeStyle: "short" });
  }

  function addAccount() {
    const name = document.getElementById("accountName").value.trim();
    const secret = document.getElementById("accountSecret").value.trim().toUpperCase();
    const group = document.getElementById("accountGroup").value.trim();
    if (!name || !/^[A-Z2-7]{16}$/.test(secret)) {
      Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Secret 16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
      return;
    }
    const accounts = loadAccounts();
    accounts.unshift({ name, secret, group, addedAt: new Date().toISOString() });
    saveAccounts(accounts);
    document.getElementById("accountName").value = "";
    document.getElementById("accountSecret").value = "";
    document.getElementById("accountGroup").value = "";
    renderAccounts();
  }

  function deleteAccount(index) {
    Swal.fire({
      title: "‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?",
      text: "‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      confirmButtonText: "‡∏•‡∏ö‡πÄ‡∏•‡∏¢"
    }).then(result => {
      if (result.isConfirmed) {
        const accounts = loadAccounts();
        accounts.splice(index, 1);
        saveAccounts(accounts);
        renderAccounts();
      }
    });
  }

  function copyOTP(code) {
    navigator.clipboard.writeText(code).then(() => {
      Swal.fire("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "OTP ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "success");
    });
  }

  function editAccount(index) {
    const accounts = loadAccounts();
    const acc = accounts[index];

    Swal.fire({
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
      html: `
        <input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" value="${acc.name}">
        <input id="swal-secret" class="swal2-input" placeholder="Secret (16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" value="${acc.secret}">
        <input id="swal-group" class="swal2-input" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" value="${acc.group || ''}">
      `,
      focusConfirm: false,
      preConfirm: () => {
        const name = document.getElementById('swal-name').value.trim();
        const secret = document.getElementById('swal-secret').value.trim().toUpperCase();
        const group = document.getElementById('swal-group').value.trim();
        if (!name || !/^[A-Z2-7]{16}$/.test(secret)) {
          Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Secret 16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          return false;
        }
        return { name, secret, group };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        accounts[index] = {
          ...accounts[index],
          name: result.value.name,
          secret: result.value.secret,
          group: result.value.group
        };
        saveAccounts(accounts);
        renderAccounts();
        Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
      }
    });
  }

  function updateProgress(index) {
    const now = Math.floor(Date.now() / 1000);
    const timeLeft = 60 - (now % 60);
    const percent = (timeLeft / 60) * 100;
    const bar = document.getElementById(`progress-${index}`);
    if (bar) {
      bar.style.width = `${percent}%`;
      bar.className = `absolute h-3 rounded progress-bar ${timeLeft > 40 ? 'bg-green-500' : timeLeft > 20 ? 'bg-yellow-400' : 'bg-red-500'}`;
    }
    setTimeout(() => updateProgress(index), 1000);
  }

  async function renderAccounts() {
    const container = document.getElementById("accountList");
    const totalDisplay = document.getElementById("accountTotal");
    const groupSelect = document.getElementById("groupFilter");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const groupFilter = groupSelect.value;

    let accounts = loadAccounts().filter(acc => acc.name.toLowerCase().includes(search));
    if (groupFilter) {
      accounts = accounts.filter(acc => acc.group === groupFilter);
    }

    const groups = [...new Set(loadAccounts().map(acc => acc.group).filter(Boolean))];
    groupSelect.innerHTML = `<option value="">üìÅ ‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</option>` + groups.map(g => `<option value="${g}" ${g === groupFilter ? 'selected' : ''}>üìÅ ${g}</option>`).join("");

    totalDisplay.textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î : ${accounts.length}`;
    container.innerHTML = "";

    const now = Math.floor(Date.now() / 1000);
    const counter = Math.floor(now / 60);

    for (let i = 0; i < accounts.length; i++) {
      const acc = accounts[i];
      const otp = await generateGarenaOTP(acc.secret, counter);
      const card = document.createElement("div");
      card.className = "bg-white p-5 rounded-xl shadow-lg border border-gray-200";
      card.innerHTML = `
        <div class="text-center md:text-left">
          <div class="text-2xl font-semibold text-blue-700">${acc.name} ${acc.group ? `<span class="text-sm text-gray-400">(${acc.group})</span>` : ''}</div>
          <div class="text-sm text-gray-500 mt-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ : ${formatThaiDate(acc.addedAt)}</div>
          <div class="text-4xl font-mono mt-2 tracking-widest">${otp}</div>
          <div class="mt-3 relative h-3 bg-gray-300 rounded overflow-hidden w-full">
            <div id="progress-${i}" class="absolute h-3 bg-green-500 rounded progress-bar" style="width: 100%"></div>
          </div>
        </div>
        <div class="mt-4 flex flex-col md:flex-row gap-3">
          <button onclick="copyOTP('${otp}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
          <button onclick="editAccount(${i})" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button onclick="deleteAccount(${i})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg">‡∏•‡∏ö</button>
        </div>
      `;
      container.appendChild(card);
      updateProgress(i);
    }
  }

  renderAccounts();
  setInterval(renderAccounts, 10000);
</script>
